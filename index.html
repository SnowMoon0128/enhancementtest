<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš”ï¸ ê°•í™” ì‹œë®¬ë ˆì´í„°</title>
<style>
:root {
    --bg-primary: #0d0d1a;
    --bg-secondary: #141428;
    --bg-card: #1a1a35;
    --bg-card-hover: #22224a;
    --text-primary: #e8e8f0;
    --text-secondary: #8888aa;
    --text-muted: #555577;
    --accent-gold: #ffd700;
    --accent-gold-dark: #b8960f;
    --accent-gem: #00ccff;
    --accent-gem-dark: #0088aa;
    --tier1: #4ade80;
    --tier2: #60a5fa;
    --tier3: #c084fc;
    --tier4: #fb923c;
    --tier5: #f43f5e;
    --success-color: #22c55e;
    --fail-color: #ef4444;
    --disable-color: #6b7280;
    --border-color: #2a2a50;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
}
.header {
    background: linear-gradient(135deg, #1a1a40, #0d0d2a);
    border-bottom: 2px solid var(--border-color);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.header h1 { font-size: 1.5em; letter-spacing: 2px; }
.tab-bar { display: flex; gap: 8px; }
.tab-btn {
    padding: 10px 24px;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 6px;
    font-size: 0.95em;
    transition: all 0.2s;
}
.tab-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
.tab-btn.active {
    background: linear-gradient(135deg, #2a2a60, #1a1a45);
    color: var(--text-primary);
    border-color: #4444aa;
    box-shadow: 0 0 12px rgba(80,80,200,0.3);
}
.tab-content { display: none; padding: 20px; }
.tab-content.active { display: block; }

/* Currency Bar */
.currency-bar {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.currency-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg-card);
    padding: 12px 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}
.currency-icon { font-size: 1.5em; }
.currency-label { color: var(--text-secondary); font-size: 0.9em; }
.currency-amount { font-size: 1.3em; font-weight: bold; min-width: 100px; text-align: right; }
.currency-amount.gold-text { color: var(--accent-gold); }
.currency-amount.gem-text { color: var(--accent-gem); }
.charge-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.85em;
    transition: all 0.2s;
}
.charge-btn.gold-charge {
    background: linear-gradient(135deg, var(--accent-gold), var(--accent-gold-dark));
    color: #1a1a00;
}
.charge-btn.gem-charge {
    background: linear-gradient(135deg, var(--accent-gem), var(--accent-gem-dark));
    color: #001a22;
}
.charge-btn:hover { transform: scale(1.05); filter: brightness(1.15); }
.charge-btn:active { transform: scale(0.97); }

/* Panels */
.panels { display: flex; gap: 20px; align-items: flex-start; }
.panel {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 20px;
}
.panel-title {
    font-size: 1.15em;
    font-weight: bold;
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.inventory-panel { width: 340px; min-height: 500px; flex-shrink: 0; }
.enhance-panel { flex: 1; min-height: 500px; }

/* Equipment List */
.add-btn {
    padding: 6px 14px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: bold;
    transition: all 0.2s;
}
.add-btn:hover { filter: brightness(1.15); transform: scale(1.03); }
.equip-list { display: flex; flex-direction: column; gap: 8px; max-height: 430px; overflow-y: auto; padding-right: 4px; }
.equip-list::-webkit-scrollbar { width: 6px; }
.equip-list::-webkit-scrollbar-track { background: var(--bg-secondary); border-radius: 3px; }
.equip-list::-webkit-scrollbar-thumb { background: #444466; border-radius: 3px; }
.equip-card {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--bg-secondary);
    border: 2px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.equip-card:hover { background: var(--bg-card-hover); }
.equip-card.selected { border-color: #6666cc; box-shadow: 0 0 10px rgba(100,100,200,0.3); }
.equip-card.disabled-equip { opacity: 0.5; }
.equip-card.disabled-equip .equip-name { text-decoration: line-through; }
.equip-info { flex: 1; }
.equip-name { font-weight: bold; font-size: 0.95em; }
.equip-level { font-size: 0.8em; color: var(--text-secondary); margin-top: 2px; }
.equip-badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.7em;
    font-weight: bold;
}
.badge-max { background: linear-gradient(135deg, #f43f5e, #dc2626); color: white; }
.badge-disabled { background: #444; color: #999; }
.discard-btn {
    padding: 4px 10px;
    background: #3a2222;
    border: 1px solid #553333;
    border-radius: 4px;
    color: #ff6666;
    cursor: pointer;
    font-size: 0.75em;
    transition: all 0.2s;
}
.discard-btn:hover { background: #552222; }
.equip-mini-bar { display: flex; gap: 1px; margin-top: 4px; }
.mini-seg { width: 12px; height: 4px; border-radius: 1px; background: #222240; }
.mini-seg.filled { opacity: 0.9; }

/* Enhance Panel */
.enhance-empty {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: var(--text-muted);
    font-size: 1.1em;
}
.enhance-header { text-align: center; margin-bottom: 16px; }
.enhance-equip-name { font-size: 1.4em; font-weight: bold; margin-bottom: 4px; }
.enhance-level-display { font-size: 2.5em; font-weight: bold; margin: 10px 0; }
.level-bar { display: flex; gap: 2px; justify-content: center; margin: 14px 0; flex-wrap: wrap; }
.level-seg {
    width: 30px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: bold;
    border-radius: 4px;
    background: #1a1a2e;
    color: #333350;
    transition: all 0.3s;
    border: 1px solid #222240;
}
.level-seg.active { color: white; }
.level-seg.active.t1 { background: var(--tier1); border-color: var(--tier1); }
.level-seg.active.t2 { background: var(--tier2); border-color: var(--tier2); }
.level-seg.active.t3 { background: var(--tier3); border-color: var(--tier3); }
.level-seg.active.t4 { background: var(--tier4); border-color: var(--tier4); }
.level-seg.active.t5 { background: var(--tier5); border-color: var(--tier5); }
.level-seg.current {
    transform: scale(1.15);
    z-index: 2;
    box-shadow: 0 0 12px currentColor;
}
.level-seg.checkpoint { border-width: 2px; }
.enhance-options { display: flex; gap: 20px; margin-top: 20px; justify-content: center; flex-wrap: wrap; }
.enhance-option-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 20px;
    width: 280px;
    text-align: center;
}
.enhance-option-card h3 { margin-bottom: 12px; font-size: 1.05em; }
.prob-bar-container { margin: 8px 0; text-align: left; }
.prob-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 0.85em; }
.prob-label { width: 35px; text-align: right; color: var(--text-secondary); }
.prob-bar-bg { flex: 1; height: 16px; background: #222240; border-radius: 3px; overflow: hidden; }
.prob-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.prob-bar-fill.prob-success { background: var(--success-color); }
.prob-bar-fill.prob-fail { background: var(--fail-color); }
.prob-bar-fill.prob-disable { background: var(--disable-color); }
.prob-pct { width: 36px; font-size: 0.85em; color: var(--text-secondary); }
.cost-display { margin: 12px 0; font-size: 0.95em; color: var(--text-secondary); }
.cost-display strong { color: var(--text-primary); }
.enhance-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 8px;
    font-size: 1.05em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
}
.enhance-btn.gold-enhance {
    background: linear-gradient(135deg, #b8960f, #8a6f0a);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.enhance-btn.gem-enhance {
    background: linear-gradient(135deg, #0088cc, #006699);
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}
.enhance-btn:hover:not(:disabled) { filter: brightness(1.2); transform: scale(1.02); }
.enhance-btn:active:not(:disabled) { transform: scale(0.98); }
.enhance-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(0.5); }
.enhance-unavailable { color: var(--text-muted); font-size: 0.85em; margin-top: 10px; }

/* Result Overlay */
.result-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
}
.result-overlay.show { opacity: 1; pointer-events: auto; }
.result-overlay.result-success { background: rgba(34, 197, 94, 0.15); }
.result-overlay.result-failure { background: rgba(239, 68, 68, 0.15); }
.result-overlay.result-disable { background: rgba(0, 0, 0, 0.6); }
.result-icon-big { font-size: 5em; margin-bottom: 10px; }
.result-text-big {
    font-size: 2.5em;
    font-weight: bold;
    text-shadow: 0 0 30px currentColor;
}
.result-sub { font-size: 1.2em; color: var(--text-secondary); margin-top: 8px; }
.result-overlay.result-success .result-text-big { color: var(--success-color); }
.result-overlay.result-failure .result-text-big { color: var(--fail-color); }
.result-overlay.result-disable .result-text-big { color: var(--disable-color); }

@keyframes shakeAnim {
    0%,100% { transform: translateX(0); }
    15%,45%,75% { transform: translateX(-8px); }
    30%,60%,90% { transform: translateX(8px); }
}
.shake { animation: shakeAnim 0.4s ease-in-out; }

/* Log */
.enhance-log {
    margin-top: 20px;
    border-top: 1px solid var(--border-color);
    padding-top: 14px;
}
.log-title { font-size: 0.95em; color: var(--text-secondary); margin-bottom: 8px; }
.log-list { max-height: 180px; overflow-y: auto; font-size: 0.82em; }
.log-list::-webkit-scrollbar { width: 4px; }
.log-list::-webkit-scrollbar-thumb { background: #444466; border-radius: 2px; }
.log-entry { padding: 3px 0; color: var(--text-secondary); border-bottom: 1px solid #1a1a30; }
.log-entry.log-success { color: var(--success-color); }
.log-entry.log-failure { color: var(--fail-color); }
.log-entry.log-disable { color: var(--disable-color); }
.manual-stats {
    margin-top: 16px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    font-size: 0.85em;
    color: var(--text-secondary);
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
}
.manual-stats span { text-align: center; }
.manual-stats .stat-val { color: var(--text-primary); font-weight: bold; }

/* Simulation Tab */
.sim-container { max-width: 900px; margin: 0 auto; }
.sim-controls {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 24px;
    margin-bottom: 20px;
}
.sim-controls h2 { margin-bottom: 8px; }
.sim-desc { color: var(--text-secondary); font-size: 0.9em; margin-bottom: 16px; line-height: 1.5; }
.sim-input-group { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.sim-input-group label { color: var(--text-secondary); }
.sim-input-group input {
    width: 120px;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 1em;
    text-align: center;
}
.sim-run-btn {
    padding: 14px 40px;
    background: linear-gradient(135deg, #7c3aed, #5b21b6);
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}
.sim-run-btn:hover:not(:disabled) { filter: brightness(1.15); transform: scale(1.02); }
.sim-run-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.sim-progress { margin-top: 16px; }
.progress-bar-bg {
    width: 100%;
    height: 24px;
    background: var(--bg-secondary);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 6px;
}
.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #7c3aed, #a78bfa);
    border-radius: 12px;
    transition: width 0.1s;
    width: 0%;
}
.progress-text { font-size: 0.85em; color: var(--text-secondary); text-align: center; }

/* Simulation Results */
.sim-results {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    padding: 24px;
}
.sim-results h3 { margin-bottom: 16px; font-size: 1.15em; }
.stats-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}
.stats-table th, .stats-table td {
    padding: 10px 16px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}
.stats-table th {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    font-size: 0.9em;
    font-weight: normal;
}
.stats-table td { font-size: 0.95em; }
.stats-table tr:hover td { background: rgba(100,100,200,0.05); }
.stats-table .row-label { text-align: left; color: var(--text-secondary); font-weight: bold; }
.stats-table .gold-col { color: var(--accent-gold); }
.stats-table .gem-col { color: var(--accent-gem); }
.stats-table .equip-col { color: var(--tier3); }
.dist-section { margin-top: 20px; }
.dist-title { font-size: 0.95em; color: var(--text-secondary); margin-bottom: 10px; }
.dist-bar-row { display: flex; align-items: center; gap: 8px; margin: 1px 0; font-size: 0.8em; }
.dist-label { width: 80px; text-align: right; color: var(--text-secondary); }
.dist-bar-bg { flex: 1; height: 16px; background: #1a1a30; border-radius: 0; overflow: hidden; }
.dist-bar { height: 100%; border-radius: 0; min-width: 1px; transition: height 0.3s ease; }
.dist-count { width: 50px; color: var(--text-muted); font-size: 0.85em; }
.dist-chart-container { background: #1a1a30; border-radius: 8px; padding: 15px; margin: 8px 0; overflow-x: auto; position: relative; }
.dist-chart { position: relative; height: 280px; width: 1200px; min-width: 1200px; background: linear-gradient(to bottom, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.01) 100%); border-radius: 4px; padding: 8px; }
.dist-svg { width: 100%; height: 100%; }
.dist-curve { stroke-width: 3; fill-opacity: 0.6; stroke-opacity: 0.8; }
.dist-grid { stroke: rgba(255,255,255,0.1); stroke-width: 1; }
.dist-axis { stroke: var(--text-muted); stroke-width: 1; }
.dist-label-text { fill: var(--text-secondary); font-size: 11px; font-family: inherit; }
.dist-value-text { fill: var(--text-primary); font-size: 10px; font-family: inherit; font-weight: bold; }
.dist-legend { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75em; color: var(--text-muted); padding: 0 5px; }
.dist-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; font-size: 0.7em; }
.dist-stat { text-align: center; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 4px; }
.dist-stat-label { display: block; color: var(--text-muted); }
.dist-stat-value { display: block; color: var(--text-primary); font-weight: bold; margin-top: 2px; }
.bar-tooltip { position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.75em; pointer-events: none; z-index: 1000; border: 1px solid rgba(255,255,255,0.3); white-space: nowrap; }
.bar-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; margin-left: -4px; border: 4px solid transparent; border-top-color: rgba(0,0,0,0.9); }
.dist-bar-interactive { cursor: pointer; transition: all 0.2s ease; }
.dist-bar-interactive:hover { opacity: 1; stroke-width: 2; filter: brightness(1.3); transform: scaleY(1.05); }
.bar-count-label { fill: white; font-size: 10px; font-family: inherit; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }

.empty-inventory {
    text-align: center;
    color: var(--text-muted);
    padding: 40px 10px;
    font-size: 0.9em;
}
</style>
</head>
<body>
<div id="app">
    <header class="header">
        <h1>âš”ï¸ ê°•í™” ì‹œë®¬ë ˆì´í„°</h1>
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('manual')" id="tab-btn-manual">ğŸ”¨ ìˆ˜ë™ ê°•í™”</button>
            <button class="tab-btn" onclick="switchTab('simulation')" id="tab-btn-simulation">ğŸ“Š ì‹œë®¬ë ˆì´ì…˜</button>
        </div>
    </header>

    <!-- Manual Enhancement Tab -->
    <div id="tab-manual" class="tab-content active">
        <div class="currency-bar">
            <div class="currency-item">
                <span class="currency-icon">ğŸª™</span>
                <span class="currency-label">ê¸ˆí™”</span>
                <span class="currency-amount gold-text" id="gold-display">0</span>
                <button class="charge-btn gold-charge" onclick="chargeGold()">+100,000</button>
            </div>
            <div class="currency-item">
                <span class="currency-icon">ğŸ’</span>
                <span class="currency-label">ë³´ì„</span>
                <span class="currency-amount gem-text" id="gem-display">0</span>
                <button class="charge-btn gem-charge" onclick="chargeGems()">+100</button>
            </div>
        </div>
        <div class="panels">
            <div class="panel inventory-panel">
                <div class="panel-title">
                    <span>ğŸ“¦ ì¥ë¹„ ì¸ë²¤í† ë¦¬</span>
                    <button class="add-btn" onclick="addEquipment()">+ ì¥ë¹„ ì¶”ê°€</button>
                </div>
                <div class="equip-list" id="equip-list"></div>
            </div>
            <div class="panel enhance-panel">
                <div class="panel-title"><span>ğŸ”¨ ê°•í™”</span></div>
                <div id="enhance-content"></div>
                <div id="enhance-result-area"></div>
                <div class="enhance-log" id="enhance-log-section" style="display:none;">
                    <div class="log-title">ğŸ“œ ê°•í™” ê¸°ë¡</div>
                    <div class="log-list" id="log-list"></div>
                </div>
                <div class="manual-stats" id="manual-stats" style="display:none;"></div>
            </div>
        </div>
    </div>

    <!-- Simulation Tab -->
    <div id="tab-simulation" class="tab-content">
        <div class="sim-container">
            <div class="sim-controls">
                <h2>ğŸ”¬ ìë™ ì‹œë®¬ë ˆì´ì…˜</h2>
                <p class="sim-desc">ë³´ì„(Lv.20~32)ê³¼ ê¸ˆí™”(Lv.33~39)ë¥¼ ë³µí•© ì‚¬ìš©í•˜ì—¬<br>
                Lv.40 ì¥ë¹„ë¥¼ ë§Œë“œëŠ” ë° í•„ìš”í•œ ìì›ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.<br>
                ë¶ˆëŠ¥ ì‹œ ìƒˆ ì¥ë¹„ë¥¼ ì¶”ê°€í•˜ì—¬ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ê°•í™”í•©ë‹ˆë‹¤.</p>
                <div class="sim-input-group">
                    <label>ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜:</label>
                    <input type="number" id="sim-count" value="1000" min="1" max="100000">
                </div>
                <button class="sim-run-btn" onclick="runBatchSimulation()" id="sim-run-btn">ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
                <div class="sim-progress" id="sim-progress" style="display:none;">
                    <div class="progress-bar-bg"><div class="progress-bar-fill" id="sim-progress-fill"></div></div>
                    <div class="progress-text" id="sim-progress-text">0 / 0</div>
                </div>
            </div>
            <div class="sim-results" id="sim-results" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Result Overlay -->
<div class="result-overlay" id="result-overlay">
    <div class="result-icon-big" id="result-icon-big"></div>
    <div class="result-text-big" id="result-text-big"></div>
    <div class="result-sub" id="result-sub"></div>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const GOLD_DATA = {
    20: { success: 50, fail: 48, disable: 2, cost: 630 },
    21: { success: 50, fail: 48, disable: 2, cost: 1225 },
    22: { success: 50, fail: 48, disable: 2, cost: 1400 },
    23: { success: 50, fail: 48, disable: 2, cost: 1575 },
    24: { success: 50, fail: 48, disable: 2, cost: 1750 },
    25: { success: 50, fail: 48, disable: 2, cost: 1925 },
    26: { success: 40, fail: 57, disable: 3, cost: 2450 },
    27: { success: 40, fail: 57, disable: 3, cost: 2625 },
    28: { success: 40, fail: 57, disable: 3, cost: 2800 },
    29: { success: 40, fail: 57, disable: 3, cost: 2975 },
    30: { success: 40, fail: 57, disable: 3, cost: 3150 },
    31: { success: 30, fail: 66, disable: 4, cost: 4200 },
    32: { success: 30, fail: 66, disable: 4, cost: 4375 },
    33: { success: 30, fail: 66, disable: 4, cost: 4550 },
    34: { success: 30, fail: 66, disable: 4, cost: 4725 },
    35: { success: 30, fail: 66, disable: 4, cost: 4900 },
    36: { success: 25, fail: 70, disable: 5, cost: 6300 },
    37: { success: 25, fail: 70, disable: 5, cost: 6475 },
    38: { success: 25, fail: 70, disable: 5, cost: 6650 },
    39: { success: 25, fail: 70, disable: 5, cost: 6825 }
};

const GEM_DATA = {
    20: { success: 50, fail: 50, cost: 10 },
    21: { success: 50, fail: 50, cost: 10 },
    22: { success: 50, fail: 50, cost: 10 },
    23: { success: 50, fail: 50, cost: 10 },
    24: { success: 50, fail: 50, cost: 10 },
    25: { success: 50, fail: 50, cost: 10 },
    26: { success: 40, fail: 60, cost: 15 },
    27: { success: 40, fail: 60, cost: 15 },
    28: { success: 40, fail: 60, cost: 15 },
    29: { success: 40, fail: 60, cost: 15 },
    30: { success: 40, fail: 60, cost: 15 },
    31: { success: 30, fail: 70, cost: 30 },
    32: { success: 30, fail: 70, cost: 30 }
};

const CHECKPOINTS = [20, 25, 30, 35, 40];
const EQUIP_TYPES = ['ìŒê²€','ì¥ì°½','ì˜¤ë¸Œ','ë‹¨ê²€','ê°€ë©´','ë°©íŒ¨'];

// ============================================================
// STATE
// ============================================================
const state = {
    gold: 0,
    gems: 0,
    equipment: [],
    selectedId: null,
    nextId: 1,
    log: [],
    stats: { goldSpent: 0, gemsSpent: 0, attempts: 0, successes: 0, failures: 0, disables: 0 }
};
let isEnhancing = false;
let resultTimer = null;

// ============================================================
// HELPERS
// ============================================================
function getFloor(level) {
    let floor = 20;
    for (const cp of CHECKPOINTS) {
        if (level >= cp) floor = cp;
    }
    return floor;
}

function getTier(level) {
    if (level <= 24) return 1;
    if (level <= 29) return 2;
    if (level <= 34) return 3;
    if (level <= 39) return 4;
    return 5;
}

function getTierClass(level) { return 't' + getTier(level); }

function fmt(n) { return n.toLocaleString('ko-KR'); }

function getSelectedEquip() {
    return state.equipment.find(e => e.id === state.selectedId) || null;
}

// ============================================================
// GAME LOGIC
// ============================================================
function addEquipment() {
    const type = EQUIP_TYPES[Math.floor(Math.random() * EQUIP_TYPES.length)];
    const equip = {
        id: state.nextId++,
        name: type + ' #' + (state.nextId - 1),
        level: 20,
        disabled: false
    };
    state.equipment.push(equip);
    state.selectedId = equip.id;
    renderAll();
}

function selectEquipment(id) {
    state.selectedId = id;
    renderAll();
}

function discardEquipment(id) {
    state.equipment = state.equipment.filter(e => e.id !== id);
    if (state.selectedId === id) state.selectedId = null;
    renderAll();
}

function chargeGold() {
    state.gold += 100000;
    renderCurrency();
}

function chargeGems() {
    state.gems += 100;
    renderCurrency();
}

function enhance(currency) {
    if (isEnhancing) return;
    const equip = getSelectedEquip();
    if (!equip || equip.disabled || equip.level >= 40) return;

    let data;
    if (currency === 'gold') {
        data = GOLD_DATA[equip.level];
        if (!data || state.gold < data.cost) return;
        state.gold -= data.cost;
        state.stats.goldSpent += data.cost;
    } else {
        if (equip.level > 32) return;
        data = GEM_DATA[equip.level];
        if (!data || state.gems < data.cost) return;
        state.gems -= data.cost;
        state.stats.gemsSpent += data.cost;
    }

    isEnhancing = true;
    state.stats.attempts++;
    const fromLevel = equip.level;
    const roll = Math.random() * 100;
    const costLabel = currency === 'gold' ? `ğŸª™${fmt(data.cost)}` : `ğŸ’${fmt(data.cost)}`;

    if (roll < data.success) {
        equip.level++;
        state.stats.successes++;
        showResultOverlay('success', fromLevel, equip.level);
        addLog('success', equip.name, fromLevel, equip.level, costLabel);
    } else if (currency === 'gem' || roll < data.success + data.fail) {
        const floor = getFloor(equip.level);
        equip.level = Math.max(equip.level - 1, floor);
        state.stats.failures++;
        showResultOverlay('failure', fromLevel, equip.level);
        addLog('failure', equip.name, fromLevel, equip.level, costLabel);
    } else {
        equip.disabled = true;
        state.stats.disables++;
        showResultOverlay('disable', fromLevel, fromLevel);
        addLog('disable', equip.name, fromLevel, fromLevel, costLabel);
    }

    renderAll();
    setTimeout(() => { isEnhancing = false; }, 800);
}

function addLog(type, name, fromLv, toLv, costLabel) {
    const icons = { success: 'âœ…', failure: 'âŒ', disable: 'ğŸ’€' };
    const msgs = {
        success: `[${name}] Lv.${fromLv} â†’ Lv.${toLv}`,
        failure: `[${name}] Lv.${fromLv} â†’ Lv.${toLv}`,
        disable: `[${name}] Lv.${fromLv} ë¶ˆëŠ¥!`
    };
    state.log.unshift({ type, text: `${icons[type]} ${msgs[type]} (${costLabel})` });
    if (state.log.length > 100) state.log.length = 100;
}

// ============================================================
// RESULT OVERLAY
// ============================================================
function showResultOverlay(type, fromLv, toLv) {
    const overlay = document.getElementById('result-overlay');
    const iconEl = document.getElementById('result-icon-big');
    const textEl = document.getElementById('result-text-big');
    const subEl = document.getElementById('result-sub');

    overlay.className = 'result-overlay show result-' + type;

    if (type === 'success') {
        iconEl.textContent = 'â¬†ï¸';
        textEl.textContent = 'ê°•í™” ì„±ê³µ!';
        subEl.textContent = `Lv.${fromLv} â†’ Lv.${toLv}`;
    } else if (type === 'failure') {
        iconEl.textContent = 'â¬‡ï¸';
        textEl.textContent = 'ê°•í™” ì‹¤íŒ¨';
        subEl.textContent = fromLv === toLv ? `Lv.${fromLv} ìœ ì§€` : `Lv.${fromLv} â†’ Lv.${toLv}`;
        overlay.classList.add('shake');
    } else {
        iconEl.textContent = 'ğŸ’€';
        textEl.textContent = 'ì¥ë¹„ ë¶ˆëŠ¥!';
        subEl.textContent = 'ë” ì´ìƒ ê°•í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    }

    clearTimeout(resultTimer);
    resultTimer = setTimeout(() => {
        overlay.className = 'result-overlay';
    }, 1200);
}

// ============================================================
// RENDERING
// ============================================================
function renderAll() {
    renderCurrency();
    renderInventory();
    renderEnhancePanel();
    renderLog();
    renderManualStats();
}

function renderCurrency() {
    document.getElementById('gold-display').textContent = fmt(state.gold);
    document.getElementById('gem-display').textContent = fmt(state.gems);
}

function renderInventory() {
    const list = document.getElementById('equip-list');
    if (state.equipment.length === 0) {
        list.innerHTML = '<div class="empty-inventory">ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>"+ ì¥ë¹„ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.</div>';
        return;
    }
    let html = '';
    for (const eq of state.equipment) {
        const sel = eq.id === state.selectedId ? ' selected' : '';
        const dis = eq.disabled ? ' disabled-equip' : '';
        const tier = getTier(eq.level);
        const tierColors = { 1: 'var(--tier1)', 2: 'var(--tier2)', 3: 'var(--tier3)', 4: 'var(--tier4)', 5: 'var(--tier5)' };

        let badge = '';
        if (eq.disabled) badge = '<span class="equip-badge badge-disabled">ë¶ˆëŠ¥</span>';
        else if (eq.level >= 40) badge = '<span class="equip-badge badge-max">MAX</span>';

        let miniBar = '<div class="equip-mini-bar">';
        for (let lv = 20; lv <= 40; lv++) {
            const c = lv <= eq.level ? tierColors[getTier(lv)] : '';
            miniBar += `<div class="mini-seg${lv <= eq.level ? ' filled' : ''}" style="${c ? 'background:' + c : ''}"></div>`;
        }
        miniBar += '</div>';

        html += `<div class="equip-card${sel}${dis}" onclick="selectEquipment(${eq.id})">
            <div class="equip-info">
                <div class="equip-name" style="color:${tierColors[tier]}">${eq.name}</div>
                <div class="equip-level">Lv.${eq.level} / 40</div>
                ${miniBar}
            </div>
            ${badge}
            <button class="discard-btn" onclick="event.stopPropagation(); discardEquipment(${eq.id})">ë²„ë¦¬ê¸°</button>
        </div>`;
    }
    list.innerHTML = html;
}

function renderEnhancePanel() {
    const content = document.getElementById('enhance-content');
    const equip = getSelectedEquip();

    if (!equip) {
        content.innerHTML = '<div class="enhance-empty">â¬…ï¸ ì¥ë¹„ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì¶”ê°€í•˜ì„¸ìš”</div>';
        return;
    }

    if (equip.disabled) {
        content.innerHTML = `<div class="enhance-header">
            <div class="enhance-equip-name" style="color:var(--disable-color);text-decoration:line-through">${equip.name}</div>
            <div class="enhance-level-display" style="color:var(--disable-color)">ğŸ’€ ë¶ˆëŠ¥</div>
            <p style="color:var(--text-muted)">ì´ ì¥ë¹„ëŠ” ë” ì´ìƒ ê°•í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë²„ë¦¬ê³  ìƒˆ ì¥ë¹„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</p>
        </div>`;
        return;
    }

    if (equip.level >= 40) {
        content.innerHTML = `<div class="enhance-header">
            <div class="enhance-equip-name" style="color:var(--tier5)">${equip.name}</div>
            <div class="enhance-level-display" style="color:var(--tier5)">ğŸ† Lv.MAX</div>
            ${buildLevelBar(equip.level)}
            <p style="color:var(--accent-gold);font-size:1.1em;margin-top:10px">âœ¨ ìµœëŒ€ ê°•í™” ë‹¬ì„±! âœ¨</p>
        </div>`;
        return;
    }

    const tierColors = { 1: 'var(--tier1)', 2: 'var(--tier2)', 3: 'var(--tier3)', 4: 'var(--tier4)', 5: 'var(--tier5)' };
    const tierColor = tierColors[getTier(equip.level)];
    const floor = getFloor(equip.level);

    let html = `<div class="enhance-header">
        <div class="enhance-equip-name" style="color:${tierColor}">${equip.name}</div>
        <div class="enhance-level-display" style="color:${tierColor}">Lv.${equip.level}</div>
        ${buildLevelBar(equip.level)}
        <div style="font-size:0.8em;color:var(--text-muted);margin-top:4px">ì•ˆì „ í•˜í•œ: Lv.${floor}</div>
    </div>`;

    html += '<div class="enhance-options">';

    // Gold option
    const gd = GOLD_DATA[equip.level];
    if (gd) {
        const canAffordGold = state.gold >= gd.cost;
        html += `<div class="enhance-option-card">
            <h3>ğŸª™ ê¸ˆí™” ê°•í™”</h3>
            <div class="prob-bar-container">
                ${probRow('ì„±ê³µ', gd.success, 'prob-success')}
                ${probRow('ì‹¤íŒ¨', gd.fail, 'prob-fail')}
                ${probRow('ë¶ˆëŠ¥', gd.disable, 'prob-disable')}
            </div>
            <div class="cost-display">ë¹„ìš©: <strong style="color:var(--accent-gold)">${fmt(gd.cost)} ğŸª™</strong>
                ${canAffordGold ? '' : '<span style="color:var(--fail-color);font-size:0.8em"> (ë¶€ì¡±)</span>'}
            </div>
            <button class="enhance-btn gold-enhance" onclick="enhance('gold')" ${canAffordGold ? '' : 'disabled'}>
                âš’ï¸ ê¸ˆí™”ë¡œ ê°•í™” (Lv.${equip.level} â†’ ${equip.level + 1})
            </button>
        </div>`;
    }

    // Gem option
    if (equip.level <= 32) {
        const gemd = GEM_DATA[equip.level];
        if (gemd) {
            const canAffordGem = state.gems >= gemd.cost;
            html += `<div class="enhance-option-card">
                <h3>ğŸ’ ë³´ì„ ê°•í™”</h3>
                <div class="prob-bar-container">
                    ${probRow('ì„±ê³µ', gemd.success, 'prob-success')}
                    ${probRow('ì‹¤íŒ¨', gemd.fail, 'prob-fail')}
                </div>
                <div style="font-size:0.8em;color:var(--success-color);margin:4px 0">âœ” ë¶ˆëŠ¥ ì—†ìŒ</div>
                <div class="cost-display">ë¹„ìš©: <strong style="color:var(--accent-gem)">${fmt(gemd.cost)} ğŸ’</strong>
                    ${canAffordGem ? '' : '<span style="color:var(--fail-color);font-size:0.8em"> (ë¶€ì¡±)</span>'}
                </div>
                <button class="enhance-btn gem-enhance" onclick="enhance('gem')" ${canAffordGem ? '' : 'disabled'}>
                    ğŸ’ ë³´ì„ìœ¼ë¡œ ê°•í™” (Lv.${equip.level} â†’ ${equip.level + 1})
                </button>
            </div>`;
        }
    } else {
        html += `<div class="enhance-option-card" style="opacity:0.4">
            <h3>ğŸ’ ë³´ì„ ê°•í™”</h3>
            <div class="enhance-unavailable">Lv.32 ì´í•˜ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥</div>
        </div>`;
    }

    html += '</div>';
    content.innerHTML = html;
}

function buildLevelBar(currentLevel) {
    let html = '<div class="level-bar">';
    for (let lv = 20; lv <= 40; lv++) {
        const active = lv <= currentLevel;
        const current = lv === currentLevel;
        const cp = CHECKPOINTS.includes(lv);
        let cls = 'level-seg';
        if (active) cls += ' active ' + getTierClass(lv);
        if (current) cls += ' current';
        if (cp) cls += ' checkpoint';
        html += `<div class="${cls}">${lv}</div>`;
    }
    html += '</div>';
    return html;
}

function probRow(label, pct, cls) {
    return `<div class="prob-row">
        <span class="prob-label">${label}</span>
        <div class="prob-bar-bg"><div class="prob-bar-fill ${cls}" style="width:${pct}%"></div></div>
        <span class="prob-pct">${pct}%</span>
    </div>`;
}

function renderLog() {
    const section = document.getElementById('enhance-log-section');
    const list = document.getElementById('log-list');
    if (state.log.length === 0) {
        section.style.display = 'none';
        return;
    }
    section.style.display = 'block';
    list.innerHTML = state.log.map(l =>
        `<div class="log-entry log-${l.type}">${l.text}</div>`
    ).join('');
}

function renderManualStats() {
    const el = document.getElementById('manual-stats');
    const s = state.stats;
    if (s.attempts === 0) { el.style.display = 'none'; return; }
    el.style.display = 'grid';
    el.innerHTML = `
        <span>ì‹œë„ <span class="stat-val">${fmt(s.attempts)}</span></span>
        <span>ì„±ê³µ <span class="stat-val" style="color:var(--success-color)">${fmt(s.successes)}</span></span>
        <span>ì‹¤íŒ¨ <span class="stat-val" style="color:var(--fail-color)">${fmt(s.failures)}</span></span>
        <span>ë¶ˆëŠ¥ <span class="stat-val" style="color:var(--disable-color)">${fmt(s.disables)}</span></span>
        <span>ê¸ˆí™” <span class="stat-val" style="color:var(--accent-gold)">${fmt(s.goldSpent)}</span></span>
        <span>ë³´ì„ <span class="stat-val" style="color:var(--accent-gem)">${fmt(s.gemsSpent)}</span></span>
    `;
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('tab-btn-' + tab).classList.add('active');
}

// ============================================================
// SIMULATION
// ============================================================
function simulateOnce() {
    let level = 20;
    let goldSpent = 0;
    let gemsSpent = 0;
    let equipmentUsed = 1;
    let attempts = 0;
    const MAX_ITER = 2000000;

    while (level < 40 && attempts < MAX_ITER) {
        attempts++;
        let data, isGem;

        if (level <= 32 && GEM_DATA[level]) {
            data = GEM_DATA[level];
            gemsSpent += data.cost;
            isGem = true;
        } else {
            data = GOLD_DATA[level];
            if (!data) break;
            goldSpent += data.cost;
            isGem = false;
        }

        const roll = Math.random() * 100;

        if (roll < data.success) {
            level++;
        } else if (isGem || roll < data.success + data.fail) {
            const floor = getFloor(level);
            level = Math.max(level - 1, floor);
        } else {
            // Disable â€” gold only
            equipmentUsed++;
            level = 20;
        }
    }

    return { goldSpent, gemsSpent, equipmentUsed, attempts };
}

async function runBatchSimulation() {
    const countInput = document.getElementById('sim-count');
    const count = Math.min(Math.max(parseInt(countInput.value) || 1000, 1), 100000);
    countInput.value = count;

    const btn = document.getElementById('sim-run-btn');
    const progressDiv = document.getElementById('sim-progress');
    const progressFill = document.getElementById('sim-progress-fill');
    const progressText = document.getElementById('sim-progress-text');

    btn.disabled = true;
    progressDiv.style.display = 'block';

    const results = [];
    const chunkSize = Math.max(1, Math.min(100, Math.floor(count / 50)));

    for (let i = 0; i < count; i += chunkSize) {
        const end = Math.min(i + chunkSize, count);
        for (let j = i; j < end; j++) {
            results.push(simulateOnce());
        }
        const pct = Math.round((end / count) * 100);
        progressFill.style.width = pct + '%';
        progressText.textContent = `${fmt(end)} / ${fmt(count)} (${pct}%)`;
        await new Promise(r => setTimeout(r, 0));
    }

    btn.disabled = false;
    progressDiv.style.display = 'none';
    renderSimResults(results, count);
}

function calcStats(arr) {
    const sorted = [...arr].sort((a, b) => a - b);
    const n = sorted.length;
    const sum = sorted.reduce((a, b) => a + b, 0);
    const mean = sum / n;
    const median = n % 2 === 0 ? (sorted[n / 2 - 1] + sorted[n / 2]) / 2 : sorted[Math.floor(n / 2)];
    const variance = sorted.reduce((acc, v) => acc + (v - mean) ** 2, 0) / n;
    const stdDev = Math.sqrt(variance);
    return {
        mean: Math.round(mean),
        median: Math.round(median),
        min: sorted[0],
        max: sorted[n - 1],
        stdDev: Math.round(stdDev),
        p25: sorted[Math.floor(n * 0.25)],
        p75: sorted[Math.floor(n * 0.75)]
    };
}

function renderSimResults(results, count) {
    const el = document.getElementById('sim-results');
    el.style.display = 'block';

    const golds = results.map(r => r.goldSpent);
    const gems = results.map(r => r.gemsSpent);
    const equips = results.map(r => r.equipmentUsed);

    const gs = calcStats(golds);
    const ges = calcStats(gems);
    const es = calcStats(equips);

    let html = `<h3>ğŸ“Š ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ (${fmt(count)}íšŒ)</h3>`;
    html += `<table class="stats-table">
        <tr><th></th><th>ğŸª™ ê¸ˆí™”</th><th>ğŸ’ ë³´ì„</th><th>ğŸ›¡ï¸ ì¥ë¹„ ìˆ˜</th></tr>
        ${statsRow('í‰ê· ', gs.mean, ges.mean, es.mean)}
        ${statsRow('ì¤‘ì•™ê°’', gs.median, ges.median, es.median)}
        ${statsRow('ìµœì†Ÿê°’', gs.min, ges.min, es.min)}
        ${statsRow('ìµœëŒ“ê°’', gs.max, ges.max, es.max)}
        ${statsRow('í‘œì¤€í¸ì°¨', gs.stdDev, ges.stdDev, es.stdDev)}
        ${statsRow('í•˜ìœ„ 25%', gs.p25, ges.p25, es.p25)}
        ${statsRow('ìƒìœ„ 25%', gs.p75, ges.p75, es.p75)}
    </table>`;

    // Equipment count distribution
    html += '<div class="dist-section">';
    html += '<div class="dist-title">ğŸ›¡ï¸ ì¥ë¹„ ì‚¬ìš© ìˆ˜ ë¶„í¬</div>';
    html += buildSmoothHistogram(equips, 'var(--tier3)', count, 'ê°œ', true);
    html += '</div>';

    // Gold distribution (buckets)
    html += '<div class="dist-section" style="margin-top:16px">';
    html += '<div class="dist-title">ğŸª™ ê¸ˆí™” ì†Œëª¨ ë¶„í¬</div>';
    html += buildHistogram(golds, 'var(--accent-gold)', count);
    html += '</div>';

    // Gem distribution
    html += '<div class="dist-section" style="margin-top:16px">';
    html += '<div class="dist-title">ğŸ’ ë³´ì„ ì†Œëª¨ ë¶„í¬</div>';
    html += buildHistogram(gems, 'var(--accent-gem)', count);
    html += '</div>';

    el.innerHTML = html;
}

function statsRow(label, gold, gem, equip) {
    return `<tr>
        <td class="row-label">${label}</td>
        <td class="gold-col">${fmt(gold)}</td>
        <td class="gem-col">${fmt(gem)}</td>
        <td class="equip-col">${fmt(equip)}</td>
    </tr>`;
}

function buildHistogram(values, color, total) {
    return buildSmoothHistogram(values, color, total, '');
}

function buildSmoothHistogram(values, color, total, unit = '', isDiscrete = false) {
    const sorted = [...values].sort((a, b) => a - b);
    const min = sorted[0];
    const max = sorted[sorted.length - 1];
    const range = max - min;
    const mean = sorted.reduce((a, b) => a + b, 0) / sorted.length;
    const median = sorted[Math.floor(sorted.length / 2)];
    const stdDev = calculateStandardDeviation(sorted);
    
    // ë§‰ëŒ€ ê°œìˆ˜
    const barCount = 45;
    
    // ì‹¤ì œ ë°ì´í„° ë¶„í¬ë¥¼ ë§‰ëŒ€ì— í• ë‹¹
    const buckets = new Array(barCount).fill(0);
    const bucketSize = range / barCount;
    
    for (const v of sorted) {
        const bucketIndex = Math.min(barCount - 1, Math.floor((v - min) / bucketSize));
        buckets[bucketIndex]++;
    }
    
    const maxCount = Math.max(...buckets);
    const totalData = buckets.reduce((a, b) => a + b, 0);
    const centerIndex = Math.min(barCount - 1, Math.max(0, Math.round((mean - min) / bucketSize)));
    const tooltipId = 'tooltip-' + Math.random().toString(36).substr(2, 9);
    
    let html = '<div class="dist-chart-container">';
    html += '<div class="dist-chart">';
    html += '<svg class="dist-svg" viewBox="0 0 1150 260">';
    
    // Grid lines (ë” ë§ì€ ê²©ìì„ )
    for (let i = 0; i <= 8; i++) {
        const y = 30 + (i * 25);
        html += `<line class="dist-grid" x1="60" y1="${y}" x2="1090" y2="${y}"/>`;
    }
    
    // ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    const chartWidth = 1030;
    const barWidth = chartWidth / barCount;
    const maxBarHeight = 170; // ë†’ì´ ì¦ê°€
    
    for (let i = 0; i < barCount; i++) {
        const x = 60 + (i * barWidth);
        const height = maxCount > 0 ? (buckets[i] / maxCount * maxBarHeight) : 0;
        const y = 230 - height;
        
        // êµ¬ê°„ ê³„ì‚°
        const rangeStart = min + (i * bucketSize);
        const rangeEnd = min + ((i + 1) * bucketSize);
        const actualCount = buckets[i] || 0;
        const percentage = total > 0 ? ((actualCount / total) * 100).toFixed(1) : '0.0';
        
        // ë§‰ëŒ€ ê·¸ë¦¬ê¸° (interactive)
        const tooltipRange = `${fmt(Math.round(rangeStart))} ~ ${fmt(Math.round(rangeEnd))}${unit}`;
        const tooltipCount = `${fmt(actualCount)}íšŒ (${percentage}%)`;
        html += `<rect class="dist-bar-interactive" x="${x + 1}" y="${y}" width="${barWidth - 2}" height="${height}" 
                 fill="${color}" opacity="0.8" stroke="${color}" stroke-width="1"
                 onmouseover="showBarTooltip(event, '${tooltipRange.replace(/'/g, "&#39;")}', '${tooltipCount.replace(/'/g, "&#39;")}', '${tooltipId}')"
                 onmousemove="moveBarTooltip(event, '${tooltipId}')"
                 onmouseout="hideBarTooltip('${tooltipId}')"/>`;
        
        // ì¤‘ì•™ ë§‰ëŒ€ ê°•ì¡°
        if (i === centerIndex) {
            html += `<rect x="${x + 1}" y="${y}" width="${barWidth - 2}" height="${height}" fill="none" stroke="white" stroke-width="3" opacity="0.9"/>`;
        }
        
        // ë§‰ëŒ€ ìœ„ì— ë°ì´í„° ê°œìˆ˜ í‘œì‹œ (ê°’ì´ ìˆê³  ì¶©ë¶„íˆ ë†’ì„ ë•Œë§Œ)
        if (actualCount > 0 && height > 20) {
            const textY = y - 8;
            html += `<text class="bar-count-label" x="${x + barWidth/2}" y="${textY}" text-anchor="middle">${actualCount}</text>`;
        }
        
        // êµ¬ê°„ ë¼ë²¨ (ì•„ë˜ìª½) - ë” ê°„ê²©ì„ ë‘ê³  í‘œì‹œ
        if (i % 5 === 0 || i === 0 || i === barCount - 1) { // 5ì¹¸ë§ˆë‹¤, ì²« ë²ˆì§¸, ë§ˆì§€ë§‰ë§Œ í‘œì‹œ
            html += `<text class="dist-label-text" x="${x + barWidth/2}" y="250" text-anchor="middle" font-size="9">${fmt(Math.round(rangeStart))}${unit}</text>`;
        }
    }
    
    // ë§ˆì§€ë§‰ êµ¬ê°„ ëê°’ í‘œì‹œ
    html += `<text class="dist-label-text" x="${60 + chartWidth}" y="250" text-anchor="middle" font-size="9">${fmt(Math.round(max))}${unit}</text>`;
    
    // ì¶•
    html += '<line class="dist-axis" x1="60" y1="230" x2="1090" y2="230"/>'; // X-axis
    html += '<line class="dist-axis" x1="60" y1="30" x2="60" y2="230"/>'; // Y-axis
    
    // í‰ê· ì„  í‘œì‹œ
    const meanX = 60 + ((mean - min) / range * chartWidth);
    html += `<line stroke="white" stroke-width="3" stroke-dasharray="8,4" x1="${meanX}" y1="35" x2="${meanX}" y2="230" opacity="0.9"/>`;
    html += `<text class="dist-value-text" x="${meanX}" y="25" text-anchor="middle" fill="white">í‰ê· </text>`;
    
    // Â±1Ïƒ êµ¬ê°„ í‘œì‹œ (ì‹¤ì œ í‘œì¤€í¸ì°¨ ê¸°ë°˜, ì°¨íŠ¸ ë²”ìœ„ ë‚´ë§Œ)
    const sigma1L_x = 60 + ((mean - stdDev - min) / range * chartWidth);
    const sigma1R_x = 60 + ((mean + stdDev - min) / range * chartWidth);
    
    if (sigma1L_x >= 60) {
        html += `<line stroke="rgba(255,255,255,0.6)" stroke-width="2" stroke-dasharray="4,3" x1="${sigma1L_x}" y1="45" x2="${sigma1L_x}" y2="230"/>`;
        html += `<text class="dist-label-text" x="${sigma1L_x}" y="40" text-anchor="middle" fill="rgba(255,255,255,0.8)">-1Ïƒ</text>`;
    }
    if (sigma1R_x <= 1090) {
        html += `<line stroke="rgba(255,255,255,0.6)" stroke-width="2" stroke-dasharray="4,3" x1="${sigma1R_x}" y1="45" x2="${sigma1R_x}" y2="230"/>`;
        html += `<text class="dist-label-text" x="${sigma1R_x}" y="40" text-anchor="middle" fill="rgba(255,255,255,0.8)">+1Ïƒ</text>`;
    }
    
    html += '</svg>';
    
    // íˆ´íŒ ìš”ì†Œ ì¶”ê°€
    html += `<div id="${tooltipId}" class="bar-tooltip" style="display: none;"></div>`;
    html += '</div>';
    
    // í†µê³„ ì •ë³´
    html += '<div class="dist-stats">';
    html += `<div class="dist-stat"><span class="dist-stat-label">í‰ê· </span><span class="dist-stat-value">${fmt(Math.round(mean))}${unit}</span></div>`;
    html += `<div class="dist-stat"><span class="dist-stat-label">ì¤‘ì•™ê°’</span><span class="dist-stat-value">${fmt(Math.round(median))}${unit}</span></div>`;
    html += `<div class="dist-stat"><span class="dist-stat-label">í‘œì¤€í¸ì°¨</span><span class="dist-stat-value">${fmt(Math.round(stdDev))}${unit}</span></div>`;
    html += '</div>';
    
    // ë¶„í¬ íŠ¹ì„± í‘œì‹œ
    html += '<div class="dist-legend">';
    html += `<span>ğŸ“Š ì‹¤ì œ ë¶„í¬ (${barCount}ê°œ êµ¬ê°„)</span>`;
    html += `<span>ğŸ“„ ê° êµ¬ê°„: ì•½ ${fmt(Math.round(bucketSize))}${unit}</span>`;
    html += `<span> ì´ ${fmt(total)}íšŒ ì‹œë®¬ë ˆì´ì…˜ â€¢ ë§‰ëŒ€ ìœ„ì— ê°œìˆ˜ í‘œì‹œ â€¢ ë§ˆìš°ìŠ¤ ì˜¤ë²„ë¡œ ìƒì„¸ ì •ë³´</span>`;
    html += '</div>';
    
    html += '</div>';
    return html;
}

// ê°€ìš°ì‹œì•ˆ(ì •ê·œë¶„í¬) í•¨ìˆ˜
function gaussianFunction(x, mean, stdDev) {
    const coefficient = 1 / (stdDev * Math.sqrt(2 * Math.PI));
    const exponent = -0.5 * Math.pow((x - mean) / stdDev, 2);
    return coefficient * Math.exp(exponent);
}

function smoothHistogram(data, passes = 1) {
    let result = [...data];
    for (let p = 0; p < passes; p++) {
        const smoothed = [...result];
        for (let i = 1; i < result.length - 1; i++) {
            smoothed[i] = (result[i - 1] + result[i] * 2 + result[i + 1]) / 4;
        }
        result = smoothed;
    }
    return result;
}

function calculateStandardDeviation(values) {
    const mean = values.reduce((a, b) => a + b, 0) / values.length;
    const variance = values.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / values.length;
    return Math.sqrt(variance);
}

// ============================================================
// TOOLTIP FUNCTIONS
// ============================================================
function showBarTooltip(event, rangeText, countText, tooltipId) {
    const tooltip = document.getElementById(tooltipId);
    if (!tooltip) return;
    
    tooltip.style.display = 'block';
    tooltip.innerHTML = `<strong>${rangeText}</strong><br>${countText}`;
    moveBarTooltip(event, tooltipId);
}

function moveBarTooltip(event, tooltipId) {
    const tooltip = document.getElementById(tooltipId);
    if (!tooltip) return;
    
    // ë§‰ëŒ€ì˜ ì¤‘ì‹¬ Xì¢Œí‘œ ì‚¬ìš© (ë§‰ëŒ€ ìœ„ ìˆ«ìì™€ ê°™ì€ ìœ„ì¹˜)
    const bar = event.target;
    const barRect = bar.getBoundingClientRect();
    const barCenterX = barRect.left + barRect.width / 2;
    
    // ë·°í¬íŠ¸ í¬ê¸° í™•ì¸
    const viewportWidth = window.innerWidth;
    
    // ì‹¤ì œ íˆ´íŒ ë„ˆë¹„ ì¸¡ì • (ë Œë”ë§ í›„)
    const tooltipWidth = tooltip.offsetWidth || 150;
    const tooltipHeight = tooltip.offsetHeight || 40;
    
    // Xì¢Œí‘œëŠ” ë§‰ëŒ€ ì¤‘ì‹¬ì— íˆ´íŒ ì¤‘ì‹¬ ì •ë ¬
    let finalX = barCenterX - tooltipWidth / 2;
    let finalY = barRect.top - tooltipHeight - 12; // ë§‰ëŒ€ ìœ„ìª½ (í™”ì‚´í‘œ ê³µê°„ í¬í•¨)
    
    // ì˜¤ë¥¸ìª½ ê²½ê³„ ì²´í¬
    if (finalX + tooltipWidth > viewportWidth - 5) {
        finalX = viewportWidth - tooltipWidth - 5;
    }
    
    // ì™¼ìª½ ê²½ê³„ ì²´í¬
    if (finalX < 5) {
        finalX = 5;
    }
    
    // ìœ„ìª½ ê²½ê³„ ì²´í¬
    if (finalY < 0) {
        finalY = barRect.bottom + 10; // ë§‰ëŒ€ ì•„ë˜ìª½ìœ¼ë¡œ
    }
    
    // ë·°í¬íŠ¸ ê¸°ì¤€ ê³ ì • ìœ„ì¹˜ ì„¤ì •
    tooltip.style.position = 'fixed';
    tooltip.style.left = finalX + 'px';
    tooltip.style.top = finalY + 'px';
    tooltip.style.zIndex = '10000';
}

function hideBarTooltip(tooltipId) {
    const tooltip = document.getElementById(tooltipId);
    if (tooltip) {
        tooltip.style.display = 'none';
    }
}

// ============================================================
// INIT
// ============================================================
renderAll();
</script>
</body>
</html>
